/-
Copyright 2025 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-/

import Mathlib.Analysis.SpecificLimits.Basic
import OpenConjectures.ForMathlib.Algebra.Order.Group.Pointwise.Interval
import OpenConjectures.ForMathlib.Order.Interval.Finset.Basic
import OpenConjectures.ForMathlib.Order.Interval.Finset.Nat

open Filter

open scoped Topology

namespace Set

/--
A set `S` in an order `Œ≤` where all intervals bounded above are finite is said to have
density `Œ± : ‚Ñù` (relative to a set `A`) if the proportion of `x ‚àà S` such that `x < n`
in `A` tends to `Œ±` as `n ‚Üí ‚àû`.

When `Œ≤ = ‚Ñï` this by default defines the natural density of a set
(i.e., relative to all of `‚Ñï`).
-/
def HasDensity {Œ≤ : Type*} [Preorder Œ≤] [LocallyFiniteOrderBot Œ≤]
    (S : Set Œ≤) (Œ± : ‚Ñù) (A : Set Œ≤ := Set.univ) : Prop :=
  Tendsto (fun (b : Œ≤) => ((S ‚à© A ‚à© Set.Iio b).ncard : ‚Ñù) / (A ‚à© Set.Iio b).ncard)
    atTop (ùìù Œ±)

/-- In a directed non-trivial partial order with a least element, the set of all
elements has density one. -/
@[simp]
theorem hasDensity_univ {Œ≤ : Type*} [PartialOrder Œ≤] [LocallyFiniteOrder Œ≤]
    [OrderBot Œ≤] [Nontrivial Œ≤] [IsDirected Œ≤ fun x1 x2 ‚Ü¶ x1 ‚â§ x2] :
    (@Set.univ Œ≤).HasDensity 1 := by
  simp [HasDensity]
  let ‚ü®b, hb‚ü© := Set.Iio_eventually_ncard_ne_zero Œ≤
  exact Tendsto.congr'
    (eventually_atTop.2
      ‚ü®b, fun n hn => (div_self <| Nat.cast_ne_zero.2 (hb n hn)).symm‚ü©)
    tendsto_const_nhds

example : (@Set.univ ‚Ñï).HasDensity 1 := hasDensity_univ

end Set

namespace Nat

open Set

/--
The natural density of the set of even numbers is `1 / 2`.
-/
theorem hasDensity_even : {n : ‚Ñï | Even n}.HasDensity (1 / 2) := by
  simp [HasDensity]
  have h {n : ‚Ñï} (hn : 1 ‚â§ n) : (({n : ‚Ñï | Even n} ‚à© Iio n).ncard : ‚Ñù) / n =
      if Even n then 2‚Åª¬π else (n + 1 : ‚Ñù) /  n * 2‚Åª¬π := by
    split_ifs with h
    ¬∑ rw [‚Üê image_mul_two_Iio_even h, ncard_image_of_injective _
          (mul_right_injective‚ÇÄ (by simp)), ncard_Iio,
        cast_div_charZero (even_iff_two_dvd.mp h), cast_ofNat,
        div_div_cancel_left' <| cast_ne_zero.2 (by linarith)]
    ¬∑ replace h : Even (n + 1) := by simpa [Nat.even_add', ‚Üê Nat.not_even_iff_odd]
      rw [‚Üê image_mul_two_Iio n, ncard_image_of_injective _
          (mul_right_injective‚ÇÄ (by simp)), ncard_Iio,
        cast_div (even_iff_two_dvd.mp h) (by norm_num), cast_add]; ring
  refine Tendsto.congr' (eventually_atTop.2 ‚ü®1, fun n hn => (h hn).symm‚ü©)
    (Tendsto.if' tendsto_const_nhds ?_)
  replace h : Tendsto (fun (k : ‚Ñï) => 1 + 1 / (k : ‚Ñù)) atTop (ùìù 1) := by
    simpa using Tendsto.const_add _ tendsto_one_div_atTop_nhds_zero_nat
  simpa using Tendsto.mul_const _ <|
    Tendsto.congr' (eventually_atTop.2 ‚ü®1, fun k hk => by field_simp‚ü©) h

/-- A finite set has natural density zero. -/
theorem hasDensity_zero_of_finite {S : Set ‚Ñï} (h : S.Finite) :
    S.HasDensity 0 := by
  simp [HasDensity]
  have (n : ‚Ñï) : ((S ‚à© Set.Iio n).ncard : ‚Ñù) / n ‚â§ S.ncard / n := by
    by_cases h‚ÇÄ : n = 0; simp [‚Üê Ico_bot, h‚ÇÄ]
    exact div_le_div‚ÇÄ (by simp) (by simpa using Set.ncard_inter_le_ncard_left _ _ h)
      (by simpa using n.pos_of_ne_zero h‚ÇÄ) le_rfl
  exact tendsto_of_tendsto_of_tendsto_of_le_of_le tendsto_const_nhds
    (tendsto_const_div_atTop_nhds_zero_nat S.ncard)
    (fun _ => div_nonneg (cast_nonneg _) (cast_nonneg _)) this

end Nat
